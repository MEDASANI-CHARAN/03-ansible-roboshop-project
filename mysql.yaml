- name: Configure MySQL component
  hosts: mysql
  become: yes
  tasks:

    - name: Install MySQL server
      ansible.builtin.dnf:
        name: mysql-server
        state: present

    - name: Start & enable MySQL service
      ansible.builtin.service:
        name: mysqld
        state: started
        enabled: yes

    - name: Install Python MySQL dependencies
      ansible.builtin.pip:
        name:
          - PyMySQL
          - cryptography
        executable: pip3

    - name: Check if MySQL root uses mysql_native_password
      ansible.builtin.shell: |
        sudo mysql -N -e "SELECT plugin FROM mysql.user WHERE user='root' AND host='localhost';"
      register: root_auth_plugin
      changed_when: false
      ignore_errors: yes

    - name: Debug root password check
      ansible.builtin.debug:
        msg: >
          Root password check RC = {{ root_password_check.rc }}

    # - name: Set MySQL root password (only if not set)
    #   community.mysql.mysql_user:
    #     login_user: root
    #     login_password: ''
    #     user: root
    #     host_all: yes
    #     password: 'RoboShop@1'
    #     state: present
    #   when: root_password_check.rc != 0
